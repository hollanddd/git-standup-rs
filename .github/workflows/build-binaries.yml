name: Build binaries

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.target }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: aarch64-apple-darwin
            runner: macos-14
            use-cross: false
          - target: x86_64-apple-darwin
            runner: macos-13
            use-cross: false
          - target: x86_64-unknown-linux-gnu
            runner: ubuntu-latest
            use-cross: false
          - target: aarch64-unknown-linux-gnu
            runner: ubuntu-latest
            use-cross: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross
        if: matrix.use-cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Build binary
        run: |
          if [ "${{ matrix.use-cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.target }}
          else
            cargo build --release --target ${{ matrix.target }}
          fi

      - name: Package binary
        run: |
          cd target/${{ matrix.target }}/release
          tar czf ../../../git-standup-${{ matrix.target }}.tar.gz git-standup
          cd ../../..

      - name: Upload to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload ${{ github.event.release.tag_name }} git-standup-${{ matrix.target }}.tar.gz

  update-homebrew:
    name: Update Homebrew formula
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download tarballs and compute SHA256s
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="${{ github.event.release.tag_name }}"
          version="${tag#v}"

          targets=(
            aarch64-apple-darwin
            x86_64-apple-darwin
            x86_64-unknown-linux-gnu
            aarch64-unknown-linux-gnu
          )

          declare -A shas
          for target in "${targets[@]}"; do
            file="git-standup-${target}.tar.gz"
            gh release download "$tag" -R "${{ github.repository }}" -p "$file"
            shas[$target]=$(sha256sum "$file" | cut -d' ' -f1)
          done

          echo "VERSION=${version}" >> "$GITHUB_ENV"
          echo "SHA_AARCH64_APPLE=${shas[aarch64-apple-darwin]}" >> "$GITHUB_ENV"
          echo "SHA_X86_64_APPLE=${shas[x86_64-apple-darwin]}" >> "$GITHUB_ENV"
          echo "SHA_X86_64_LINUX=${shas[x86_64-unknown-linux-gnu]}" >> "$GITHUB_ENV"
          echo "SHA_AARCH64_LINUX=${shas[aarch64-unknown-linux-gnu]}" >> "$GITHUB_ENV"

      - name: Dispatch to homebrew-tap
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          gh api repos/hollanddd/homebrew-tap/dispatches \
            -f event_type=update-git-standup \
            -f "client_payload[version]=${VERSION}" \
            -f "client_payload[sha_aarch64_apple]=${SHA_AARCH64_APPLE}" \
            -f "client_payload[sha_x86_64_apple]=${SHA_X86_64_APPLE}" \
            -f "client_payload[sha_x86_64_linux]=${SHA_X86_64_LINUX}" \
            -f "client_payload[sha_aarch64_linux]=${SHA_AARCH64_LINUX}"
